#include <stdio.h>

#include "pico/stdlib.h"
#include "pico/mutex.h"
#include "hw_config.h"
#include "sd_card.h"
#include "ff.h"
#include "f_util.h"

#include "config.h"
#include "midi.h"

int main() {
  stdio_init_all();
  gpio_init(PICO_DEFAULT_LED_PIN);
  gpio_set_dir(PICO_DEFAULT_LED_PIN, GPIO_OUT);
  gpio_put(PICO_DEFAULT_LED_PIN, 1);

  printf("Hello!\n\n");

  // uint8_t bytes[] = {
  //   0x4D, 0x54, 0x72, 0x6B, 0x00, 0x00, 0x00, 0x5D, 0x00, 0xFF, 0x03, 0x06,
  //   0x57, 0x61, 0x74, 0x73, 0x79, 0x6E, 0x00, 0xFF, 0x51, 0x03, 0x06, 0x8A,
  //   0x1B, 0x00, 0x90, 0x48, 0x40, 0x81, 0x00, 0x80, 0x48, 0x40, 0x00, 0x90,
  //   0x4A, 0x40, 0x81, 0x00, 0x80, 0x4A, 0x40, 0x00, 0x90, 0x4C, 0x40, 0x81,
  //   0x00, 0x80, 0x4C, 0x40, 0x00, 0x90, 0x4D, 0x40, 0x81, 0x00, 0x80, 0x4D,
  //   0x40, 0x00, 0x90, 0x4F, 0x40, 0x81, 0x00, 0x80, 0x4F, 0x40, 0x00, 0x90,
  //   0x51, 0x40, 0x81, 0x00, 0x80, 0x51, 0x40, 0x00, 0x90, 0x53, 0x40, 0x81,
  //   0x00, 0x80, 0x53, 0x40, 0x00, 0x90, 0x54, 0x40, 0x81, 0x00, 0x80, 0x54,
  //   0x40, 0x00, 0xFF, 0x2F, 0x00
  // };

  // midi_chunk_t chunk;
  // midi_chunk_parse(&chunk, bytes, 101);

  // return 0;

  sd_card_t *sd = sd_get_by_num(0);
  mutex_init(&sd->spi->mutex);
  FRESULT fr = f_mount(&sd->fatfs, sd->pcName, 1);

  if (FR_OK != fr) {
    panic("f_mount error! %s\n", FRESULT_str(fr));
  }

  FIL file;
  fr = f_open(&file, MIDI_FILE_NAME, FA_READ);

  if (FR_OK != fr && FR_EXIST != fr) {
    panic("f_open error! %s\n", FRESULT_str(fr));
  }

  char buf[256] = "";
  fr = f_read(&file, &buf, 256, NULL);
  f_close(&file);

  f_unmount(sd->pcName);
  printf("Done\n");

  midi_file_t midi;
  midi_file_parse(&midi, (uint8_t *)buf, 114);
  printf("main returned\n");

  gpio_put(PICO_DEFAULT_LED_PIN, 0);
  for (;;) tight_loop_contents();
}